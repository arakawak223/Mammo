# 機能要件定義書

---

## F1: 「これ詐欺？」ボタン

### 概要
高齢者が不審な状況に遭遇した際、画面上の巨大なボタンを1タップするだけで、家族全員にアラートを送信する。

### 動作フロー

```
[高齢者の操作]
  │
  ├─ ホーム画面のウィジェット or アプリ常駐画面に巨大ボタン表示
  │
  ├─ ボタンタップ
  │   ├─ 端末が振動（ハプティクス）で操作確認
  │   ├─ 現在の状況を自動収集：
  │   │   ├─ 直近の着信番号（通話中なら通話相手番号）
  │   │   ├─ GPS位置情報
  │   │   ├─ タイムスタンプ
  │   │   └─ （オプション）直近のSMS/通話履歴サマリー
  │   │
  │   └─ サーバーへ送信 → 家族全員にプッシュ通知
  │
  └─ 画面表示：「家族に連絡しました。安心してください。」（大きな文字）
```

### 必要データ

| データ | 取得元 | 備考 |
|--------|--------|------|
| 直近の着信番号 | CallLog API (Android) / CallKit (iOS) | iOS制限あり（後述） |
| GPS座標 | FusedLocationProvider / CLLocationManager | バックグラウンド位置情報パーミッション必要 |
| タイムスタンプ | システム時計 | UTC保存、表示はローカルTZ |
| デバイス状態 | 通話中/待受/SMS閲覧中 | 状況判断の補助情報 |

### 技術的課題

1. **iOS の CallKit 制限**：iOSでは通話ログへのプログラム的アクセスが制限されている。CallDirectory Extension で着信識別は可能だが、リアルタイムの通話相手番号取得は困難。→ 代替策：ユーザーがボタンを押した直後の画面スクリーンショットのOCR、または通話終了後に CallKit の CXCallObserver で番号取得。
2. **誤タップ防止**：ボタンが巨大なため誤タップの可能性。→ 長押し（0.5秒）で発動、または発動後3秒以内にキャンセル可能にする。
3. **オフライン時**：インターネット未接続時はローカルキューイングし、接続回復後に自動送信。

### 受入条件

- [ ] 1タップ（長押し0.5秒）でアラートが送信される
- [ ] アラート送信から家族へのプッシュ通知到達まで5秒以内
- [ ] オフライン時はキューイングされ、接続回復後に送信される
- [ ] 3秒以内のキャンセルが可能

---

## F2: 自動転送機能

### 概要
国際電話（+番号）、非通知、未登録番号からの着信・SMSを検知し、家族へ自動的に通知する。

### 動作フロー

```
[バックグラウンドサービス]
  │
  ├─ 着信検知 (BroadcastReceiver / CallKit)
  │   ├─ 番号を抽出
  │   ├─ 判定ルール適用：
  │   │   ├─ 国際番号（+81以外で始まる番号）→ 高リスク
  │   │   ├─ 非通知 → 高リスク
  │   │   ├─ 連絡先未登録 → 中リスク
  │   │   └─ 登録済み → 低リスク（通知なし）
  │   │
  │   ├─ 高/中リスク → サーバー送信 → 家族プッシュ通知
  │   └─ ログ保存（全着信）
  │
  ├─ SMS検知 (SMS BroadcastReceiver)
  │   ├─ 送信元番号 + 本文を取得
  │   ├─ 上記と同じ番号判定
  │   ├─ 本文に詐欺キーワード検出（URLリンク、「当選」「未払い」「口座」等）
  │   │   → キーワードマッチで中→高リスクへ昇格
  │   │
  │   └─ 高/中リスク → サーバー送信（本文含む）→ 家族プッシュ通知
  │
  └─ 定期的にサマリーレポートを家族に送信（1日1回）
```

### 必要データ

| データ | 取得元 | 備考 |
|--------|--------|------|
| 着信番号 | TelephonyManager / CXCallObserver | |
| SMS送信元・本文 | SmsReceiver / MessageFilter Extension | iOS は MessageFilter Extension のみ |
| 連絡先一覧 | ContactsProvider / CNContact | 既知番号の判定に使用 |
| 詐欺キーワード辞書 | サーバー配信 | 定期更新（週次） |

### 技術的課題

1. **iOS の SMS フィルタリング制限**：iOSでは `MessageFilterExtension` を使用するが、SMS本文を外部サーバーに送信することはAppleのポリシーで禁止されている。→ オンデバイスでの判定のみ実施し、判定結果（リスクレベル）のみをサーバーに送信する。
2. **Android バックグラウンド制限**：Android 12以降、バックグラウンドでのBroadcastReceiver動作に制限。→ ForegroundService（常駐通知）で対応。
3. **バッテリー消費**：常時監視によるバッテリーへの影響。→ 着信/SMS のシステムイベントに反応する方式のため、ポーリングはしない。消費は最小限。
4. **誤検知（過検知）**：未登録番号は宅配便や病院の場合もある。→ 家族側UIで「安全」マークをつけてホワイトリストに追加可能にする。

### 受入条件

- [ ] 国際番号・非通知からの着信で自動通知が送信される
- [ ] 未登録番号からの着信で自動通知が送信される
- [ ] SMSの詐欺キーワードマッチで通知リスクが昇格する
- [ ] 1日1回のサマリーレポートが家族に配信される
- [ ] 家族側からホワイトリスト登録が可能

---

## F3: AI音声アシスタント

### 概要
通話終了後に自動で音声アシスタントが起動し、「今の電話、大丈夫でしたか？」と問いかける。高齢者は音声応答のみで「不安」を伝え、AIが要約して家族に送信する。

### 動作フロー

```
[通話終了検知]
  │
  ├─ 発動条件：
  │   ├─ 未登録番号との通話が終了
  │   ├─ 通話時間が30秒以上（短すぎる通話は除外）
  │   └─ ユーザーの設定で「全通話」or「未登録番号のみ」を選択可能
  │
  ├─ 音声アシスタント起動
  │   ├─ 「今の電話、大丈夫でしたか？不安なことがあれば教えてください。」
  │   ├─ 音声認識で応答取得（最大60秒）
  │   │   ├─ 応答あり → テキスト化 → AI解析
  │   │   │   ├─ 「大丈夫」「問題ない」等 → 「安心しました。何かあればいつでも。」で終了
  │   │   │   └─ 不安キーワード検出 → 「家族に伝えておきますね。」→ 家族通知
  │   │   │
  │   │   └─ 無応答（10秒以上沈黙）→ 「何もなければ大丈夫です。」で終了
  │   │
  │   └─ 音声合成で応答（TTS）
  │
  └─ 結果をサーバーに送信（テキスト＋判定結果）
```

### 必要データ

| データ | 取得元 | 備考 |
|--------|--------|------|
| 通話終了イベント | PhoneStateListener / CXCallObserver | |
| 音声入力 | SpeechRecognizer / SFSpeechRecognizer | オンデバイス推奨 |
| テキスト化結果 | Speech-to-Text | |
| AI判定 | ローカルモデル or サーバーAPI | キーワードベース＋LLM |
| 音声合成 | TextToSpeech / AVSpeechSynthesizer | |

### 技術的課題

1. **iOS の通話終了検知**：CXCallObserver で通話状態変化は検知可能だが、バックグラウンドでの音声アシスタント起動には制限がある。→ プッシュ通知で「確認してください」と通知し、タップでアシスタント画面を開く方式を併用。
2. **音声認識精度**：高齢者の発話（方言、不明瞭な発音）に対する認識精度。→ Apple/Google のオンデバイス音声認識を使用（学習済みモデルの精度が高い）。カスタム語彙（詐欺関連ワード）を辞書登録。
3. **プライバシー**：通話内容の音声は録音しない。音声認識で得たテキストのみ処理。
4. **ユーザー体験**：通話後に毎回聞かれると煩わしい。→ 頻度制御（1日最大3回）、設定で無効化可能。

### 受入条件

- [ ] 未登録番号との通話終了後にアシスタントが自動起動する
- [ ] 音声のみで「不安」を伝達でき、家族に通知される
- [ ] 「大丈夫」系応答では家族通知をスキップする
- [ ] 1日の発動回数上限を設定可能

---

## F4: リアルタイム・アラート

### 概要
高齢者のスマホ上で検知された不審な挙動を、即座に家族全員のスマホにプッシュ通知する。

### 動作フロー

```
[イベント発生源]                    [サーバー]              [家族端末]
  │                                    │                      │
  ├─ F1:「これ詐欺？」ボタン ────→ アラート生成 ────→ プッシュ通知（最高優先度）
  ├─ F2: 不審着信/SMS ─────────→ アラート生成 ────→ プッシュ通知（高優先度）
  ├─ F3: AI判定「不安あり」────→ アラート生成 ────→ プッシュ通知（中優先度）
  ├─ F9: 緊急SOS ──────────→ アラート生成 ────→ プッシュ通知（緊急）+ サイレン音
  │                                    │                      │
  └─ 全イベントはタイムライン           │                      │
     としてDBに保存 ─────────→ ダッシュボードに       │
                                    時系列表示 ──────→ アプリ内で閲覧
```

### 通知優先度

| レベル | トリガー | 通知挙動 |
|--------|----------|----------|
| 緊急（Critical） | F9: 緊急SOS | サイレント解除、繰り返し通知、全画面表示 |
| 最高（High） | F1: 詐欺ボタン | 即座にプッシュ通知、音あり |
| 高（Medium-High） | F2: 不審着信（高リスク） | プッシュ通知、音あり |
| 中（Medium） | F2: 不審着信（中リスク）、F3 | プッシュ通知、バイブのみ |
| 低（Low） | 日次レポート | サイレント通知 |

### 必要データ

| データ | 内容 |
|--------|------|
| イベント種別 | F1〜F9のどのトリガーか |
| タイムスタンプ | イベント発生時刻 |
| 位置情報 | 高齢者の現在地 |
| 関連データ | 着信番号、SMS本文、AI判定結果 等 |
| 対応ステータス | 未対応 / 確認中 / 対応済み |

### 技術的課題

1. **通知の即時性**：FCM / APNs の通常配信では遅延が発生する場合がある。→ FCM high-priority / APNs push-type: alert で最短配信。緊急SOSは VoIP Push（iOS）を検討。
2. **通知疲れ（Alert Fatigue）**：中リスクの通知が頻発すると家族が無視するようになる。→ 同一番号からの通知は集約、通知頻度の設定可能化、日次ダイジェスト。
3. **複数家族への同時配信**：遅延なく全員に配信する必要がある。→ FCM Topic Messaging またはサーバー側で並列Push。

### 受入条件

- [ ] 緊急SOSはサイレントモードでも通知音が鳴る
- [ ] アラート発生から家族への通知到達まで5秒以内（p95）
- [ ] 通知タップでアプリ内の該当イベント詳細画面に遷移
- [ ] 家族がイベントに「対応済み」マークをつけられる

---

## F5: 会話サマリー（AI解析）

### 概要
転送された通話音声（または音声テキスト）をAIで解析し、会話の要約と詐欺危険度スコア（0〜100%）を家族に提示する。

### 動作フロー

```
[音声データ取得]
  │
  ├─ 方式A：通話録音（Android のみ、要ユーザー同意）
  │   └─ 録音ファイルをサーバーへアップロード
  │
  ├─ 方式B：AI音声アシスタント(F3)で得たテキスト
  │   └─ テキストをそのままAI解析へ
  │
  ├─ 方式C：家族が手動で音声メモをアップロード
  │   └─ 「親から聞いた話を録音して送信」
  │
  └─ [AI解析パイプライン]
      ├─ Speech-to-Text（方式Aの場合）
      │   └─ OpenAI Whisper API / Google Cloud Speech-to-Text
      │
      ├─ テキスト解析
      │   ├─ 会話サマリー生成（LLM: GPT-4 / Claude）
      │   ├─ 詐欺パターンマッチング
      │   │   ├─ オレオレ詐欺パターン
      │   │   ├─ 還付金詐欺パターン
      │   │   ├─ 架空請求パターン
      │   │   ├─ 投資詐欺パターン
      │   │   └─ ロマンス詐欺パターン
      │   │
      │   └─ 危険度スコアリング（0〜100%）
      │       ├─ 0〜30%：安全（緑）
      │       ├─ 31〜60%：注意（黄）
      │       ├─ 61〜80%：警戒（オレンジ）
      │       └─ 81〜100%：危険（赤）
      │
      └─ 結果を家族ダッシュボードに表示
          ├─ 会話サマリー（3〜5行）
          ├─ 危険度スコア（ゲージ表示）
          ├─ 検出された詐欺手口の種類
          └─ 推奨アクション（「着信拒否を推奨」「警察相談を推奨」等）
```

### 必要データ

| データ | 取得元 | 備考 |
|--------|--------|------|
| 通話録音 | Android CallRecording API | Android 9+ で制限あり、ユーザー同意必須 |
| テキスト | F3の音声認識結果 | 通話そのものではなく事後ヒアリング |
| 詐欺パターンDB | サーバー管理 | 警察庁公開データ＋独自収集 |
| LLMプロンプト | サーバー管理 | プロンプトエンジニアリングで精度向上 |

### 技術的課題

1. **通話録音の法的制約**：日本では通話録音の一方当事者同意は合法だが、アプリによる自動録音はキャリア/OS の制約が厳しい。→ Android: Accessibility Service は Google Play ポリシーで不可。代替として通話後の手動録音誘導、または F3 のテキストベース解析を主軸にする。iOS: 通話録音は不可。F3 のテキスト解析のみ。
2. **AI精度**：詐欺手口は日々変化する。→ プロンプトと詐欺パターンDBを週次更新。ユーザーフィードバック（「これは詐欺だった/詐欺ではなかった」）で精度改善。
3. **コスト**：LLM API呼び出しのコスト。→ 短いテキスト（F3経由）は安価。録音データのSTT＋LLMは従量課金のため、月間利用上限を設定。

### 受入条件

- [ ] テキストから3〜5行のサマリーが生成される
- [ ] 危険度スコアが0〜100で算出される
- [ ] 既知の詐欺パターン5種を正しく分類できる（精度80%以上）
- [ ] 解析結果が60秒以内に家族ダッシュボードに表示される

---

## F6: リモート・ブロック

### 概要
家族のスマホから、高齢者のスマホの着信拒否リスト（ブロックリスト）を遠隔で編集する。

### 動作フロー

```
[家族アプリ]
  │
  ├─ ダッシュボードのアラート詳細画面
  │   └─ 「この番号をブロック」ボタン
  │
  ├─ ブロックリスト管理画面
  │   ├─ 現在のブロックリスト一覧表示
  │   ├─ 番号の追加（手動入力 or アラートから）
  │   ├─ 番号の削除（解除）
  │   └─ 一括インポート（既知の詐欺番号DB）
  │
  └─ サーバーへ変更を送信
      │
      └─ [高齢者端末]
          ├─ 変更をプル（プッシュ通知トリガー）
          ├─ Android: BlockedNumberContract API でシステムブロックリスト更新
          └─ iOS: CallDirectory Extension でブロックリスト更新
              └─ ※ Extension のリロードが必要
```

### 必要データ

| データ | 内容 |
|--------|------|
| ブロックリスト | 電話番号のリスト（サーバーでマスター管理） |
| 詐欺番号DB | 警察・通信事業者公開の既知詐欺番号 |
| 操作ログ | 誰がいつどの番号を追加/削除したか |

### 技術的課題

1. **iOS の制限**：CallDirectory Extension でブロックできるが、Extension のリロード上限やタイミングに制約がある。また、ユーザーが「設定 > 電話 > 着信拒否設定と着信ID」でExtensionを有効にする必要がある（初期セットアップで家族が設定）。
2. **Android の制限**：BlockedNumberContract はデフォルトの電話アプリの場合のみ有効。→ 端末のデフォルト電話アプリ設定が必要（初期セットアップで対応）。
3. **同期の即時性**：番号追加後すぐにブロックが有効になる必要がある。→ FCMデータメッセージで即時プル、最大遅延30秒。
4. **誤ブロック**：正当な番号をブロックするリスク。→ 家族側に「ブロック解除」を容易にするUI。高齢者端末にも「最近ブロックされた着信」の通知。

### 受入条件

- [ ] 家族がアプリから番号を追加するとOS レベルでブロックされる
- [ ] ブロック追加から有効化まで30秒以内
- [ ] ブロックリストの追加・削除履歴が閲覧可能
- [ ] 既知詐欺番号DBからの一括インポートが可能

---

## F7: 被害額データ連動

### 概要
警察庁の最新統計データに基づき、ユーザーの居住地域で流行している詐欺手口と、それに対する具体的な対策をアドバイスする。

### 動作フロー

```
[データ収集（バッチ処理）]
  │
  ├─ 警察庁「特殊詐欺認知・検挙状況」を定期取得
  │   ├─ 月次公表データ（PDF/CSV）
  │   └─ 都道府県警察の公開データ
  │
  ├─ データ加工・構造化
  │   ├─ 都道府県別 被害額・件数
  │   ├─ 手口別 被害額・件数（オレオレ、還付金、架空請求 等）
  │   ├─ 時系列トレンド
  │   └─ 前月比・前年同月比
  │
  └─ [家族ダッシュボード表示]
      ├─ 「あなたの地域の詐欺状況」カード
      │   ├─ 地域の被害額・件数（直近月）
      │   ├─ 流行手口ランキング
      │   └─ 前月比の増減
      │
      ├─ 「今月の注意手口」アドバイス
      │   ├─ 手口の解説
      │   ├─ 具体的な対策（「〜と言われたら詐欺です」）
      │   └─ 実際の事例
      │
      └─ 週1回のダイジェストメール/通知
```

### 必要データ

| データ | 取得元 | 更新頻度 |
|--------|--------|----------|
| 全国統計 | 警察庁 特殊詐欺統計 | 月次 |
| 都道府県別統計 | 各都道府県警察HP | 月次 |
| 手口解説 | 警察庁/消費者庁 | 随時 |
| ユーザー居住地域 | 登録時に設定（都道府県） | ― |

### 技術的課題

1. **データ取得の自動化**：警察庁のデータはPDFで公開されることが多い。→ PDF解析パイプライン構築。一部は手動キュレーションも必要。将来的にはオープンデータAPI化を要望。
2. **データの鮮度**：公表が1〜2ヶ月遅れる場合がある。→ 「〇年〇月時点のデータ」と明示。速報値は報道記事からの補完も検討。
3. **アドバイスの質**：汎用的なアドバイスでは効果が薄い。→ 地域×手口×時期 の組み合わせで具体的なメッセージを生成（LLM活用）。

### 受入条件

- [ ] 47都道府県の統計データが表示される
- [ ] 月次でデータが更新される
- [ ] 地域に応じたアドバイスが表示される
- [ ] 週1回のダイジェスト通知が配信される

---

## F8: 闇バイトチェッカー

### 概要
SNS等で見かけた求人文をコピー&ペーストまたはスクリーンショットで入力すると、組織犯罪（暴力団、特殊詐欺グループ）への関与リスクを判定する。

### 動作フロー

```
[ユーザー入力]
  │
  ├─ 方式A：テキスト入力（コピペ）
  │   └─ 求人文を入力欄にペースト
  │
  ├─ 方式B：スクリーンショット
  │   └─ 画像をアップロード → OCR → テキスト化
  │
  ├─ 方式C：URL入力
  │   └─ URLのページをスクレイピング → テキスト抽出
  │
  └─ [AI解析]
      ├─ 闇バイトキーワード検出
      │   ├─ 高額報酬（「日給5万」「即日現金」等）
      │   ├─ 違法行為示唆（「受け取り」「運搬」「見張り」等）
      │   ├─ 匿名通信（「テレグラム」「シグナル」で連絡 等）
      │   ├─ 身分証要求（「免許証の写真を送って」等）
      │   └─ 曖昧な業務内容（「簡単な作業」「誰でもできる」等）
      │
      ├─ リスク判定
      │   ├─ 安全：通常の求人（緑）
      │   ├─ 注意：一部疑わしい要素あり（黄）
      │   ├─ 警戒：複数の危険要素（オレンジ）
      │   └─ 危険：闇バイトの可能性が高い（赤）
      │
      ├─ 判定理由の提示
      │   └─ 「以下の点が危険です：〜」
      │
      └─ 相談先の案内
          ├─ 警察相談ダイヤル #9110
          ├─ 若者向け相談窓口
          └─ 暴力団離脱支援
```

### 必要データ

| データ | 内容 |
|--------|------|
| 闇バイトキーワード辞書 | 危険ワードリスト（サーバー管理、定期更新） |
| 判定モデル | LLMベース + ルールベースのハイブリッド |
| 過去の判定事例 | 精度改善用フィードバックDB |
| OCRエンジン | Google ML Kit / Vision API |

### 技術的課題

1. **検出精度**：正当な高額バイト（引越し等）との区別。→ LLMによる文脈理解＋キーワードの組み合わせスコアリング。
2. **リアルタイム変化**：犯罪者側も用語を変える。→ 月次でキーワード辞書を更新。ユーザー報告によるクラウドソーシング的な更新も。
3. **若年層への訴求**：高齢者向けアプリだが、この機能は家族（若年層）や若者一般にも有用。→ この機能のみWebアプリ版としても提供検討。

### 受入条件

- [ ] テキスト入力で闇バイトリスク判定が返る
- [ ] スクリーンショットからOCRで判定が可能
- [ ] 判定理由が日本語で具体的に説明される
- [ ] 相談先の連絡先が表示される

---

## F9: 緊急ロック（緊急SOS）

### 概要
高齢者が身の危険を感じた際に、クイック操作で位置情報と周囲の音声を家族に強制送信する。暴力団関連の強盗や脅迫といった身体的危険を想定し、**2つの動作モード**を家族側から事前設定可能とする。

### SOSモード設計

特殊詐欺の背後にある暴力団組織は、詐欺だけでなく**強盗や恐喝に変貌する**ケースが増加している。この現実を踏まえ、状況に応じた2つのモードを設計する。

| モード | 名称 | 想定シーン | 動作 |
|--------|------|-----------|------|
| **アラームモード** | 防犯ブザー型 | 路上での不審者接近、訪問販売の威圧 | 大音量アラーム鳴動＋画面フラッシュ＋家族通知 |
| **サイレントモード** | 隠密通報型 | 強盗・脅迫の最中、犯人が室内にいる | 一切の音・表示変化なし＋位置情報と周囲音声を隠密送信 |

**モード設定権限**: 家族側アプリから事前に設定。デフォルトは「サイレントモード」（犯人を刺激しない安全側をデフォルトとする）。高齢者側では設定画面の深い階層に切替オプションを配置（誤操作防止）。

### 動作フロー

```
[緊急SOS発動]
  │
  ├─ 発動方法：
  │   ├─ 電源ボタン5回連打（OS標準のSOS機能と連携）
  │   ├─ アプリ内の「SOS」ボタン長押し（3秒）
  │   └─ ウィジェットの「SOS」ボタン
  │
  ├─ カウントダウン（5秒）→ キャンセル可能
  │
  ├─ モード判定（家族が事前設定した値を使用）
  │
  ├── [アラームモード] ──────────────────────────────────────────
  │   │
  │   ├─ 高齢者端末の動作：
  │   │   ├─ 大音量アラーム鳴動（音量MAX強制、イヤホン接続時はスピーカーも併用）
  │   │   ├─ 画面フラッシュ（赤白交互点滅）
  │   │   ├─ 「助けてください！」の音声自動再生（TTS）
  │   │   ├─ 位置情報の即時取得＋継続追跡（10秒間隔）
  │   │   └─ 周囲音声の録音開始（最大5分間）
  │   │
  │   ├─ 画面表示：
  │   │   ├─ 全画面赤背景「SOS発信中」
  │   │   ├─ 「110番に電話する」ボタン（大）
  │   │   └─ アラーム停止は家族側からのみ
  │   │
  │   └─ 効果：周囲の注目を集め、犯人を威嚇・牽制
  │
  ├── [サイレントモード] ────────────────────────────────────────
  │   │
  │   ├─ 高齢者端末の動作：
  │   │   ├─ 音声・振動・画面変化なし（完全サイレント）
  │   │   ├─ 画面は通常のホーム画面を維持（犯人に気づかれない）
  │   │   ├─ バックグラウンドで位置情報の即時取得＋継続追跡（10秒間隔）
  │   │   └─ バックグラウンドで周囲音声の録音開始（最大10分間）
  │   │
  │   ├─ 画面表示：
  │   │   └─ ステータスバーに極小アイコンのみ（SOS作動中を本人だけが確認可能）
  │   │
  │   └─ 効果：犯人を刺激せず、証拠音声を確保しつつ家族に通報
  │
  ├─ [サーバー処理]（両モード共通）
  │   ├─ 緊急アラートの即時配信（最高優先度）
  │   ├─ 位置情報ストリーミング（WebSocket）
  │   └─ 音声データの即時アップロード（チャンク単位）
  │
  └─ [家族端末]（両モード共通）
      ├─ 全画面アラート（サイレントモード解除で通知音）
      │   ├─ 地図上に高齢者の現在位置（リアルタイム更新）
      │   ├─ 現在のSOSモード表示（アラーム / サイレント）
      │   ├─ モード切替ボタン（状況判断で即時変更可能）
      │   ├─ 音声ストリーミング再生
      │   ├─ 「110番に通報」ボタン
      │   └─ 「解除」ボタン（高齢者に確認してから）
      │
      └─ アラート解除は家族側からのみ可能（高齢者が脅迫下で解除できないように）
```

### 必要データ

| データ | 取得元 | 備考 |
|--------|--------|------|
| GPS位置情報 | 高精度モード（GPS+WiFi+Cell） | 10秒間隔で継続取得 |
| 周囲音声 | マイク | チャンク単位でストリーミング送信 |
| SOSモード設定 | サーバー（家族が設定） | alarm / silent |
| タイムスタンプ | システム時計 | |
| デバイス情報 | バッテリー残量等 | 追跡可能性の判断材料 |

### 技術的課題

1. **バックグラウンドでの録音**：iOS/Androidともにバックグラウンドでの長時間録音は制限がある。→ iOS: Background Audio モード利用。Android: Foreground Service with microphone type。
2. **ストリーミング**：音声をリアルタイムで家族に届ける。→ WebSocket or WebRTC で低遅延ストリーミング。5秒チャンクでサーバー経由転送。
3. **バッテリー**：GPS + 録音 + ネットワーク送信で急速にバッテリー消費。→ バッテリー残量を家族に表示。低バッテリー時は位置情報のみに切り替え。
4. **OS標準SOS連携**：iOS の緊急SOS、Androidのパーソナルセーフティとの共存。→ OS標準機能を補完する位置づけ。OS標準は警察への通報、当アプリは家族への通報。
5. **悪用防止**：子供のいたずらや誤操作。→ 5秒カウントダウン＋キャンセルUI。月間発動回数の閾値超えでアラート。
6. **サイレントモードの完全性**：画面変化を一切出さないことの技術的難易度。→ ForegroundService通知はAndroidで必須だが、通知チャンネルを「サイレント・最低優先度」に設定し、目立たないアイコンを使用。iOSではバックグラウンド処理として実行。
7. **モード切替のリアルタイム性**：家族がモードを切り替えた際、即座に高齢者端末に反映される必要がある。→ WebSocket経由でモード変更コマンドを即時プッシュ（遅延1秒以内）。

### 受入条件

- [ ] 3つの発動方法のいずれかでSOSが起動する
- [ ] 発動後5秒以内に家族へ緊急通知が到達する
- [ ] 位置情報がリアルタイム（10秒間隔）で家族に共有される
- [ ] 周囲音声が家族端末でストリーミング再生可能
- [ ] 5秒以内のキャンセルが可能
- [ ] 家族側からのみ解除が可能
- [ ] アラームモードで大音量アラームが鳴動する
- [ ] サイレントモードで端末に一切の音・画面変化がない
- [ ] 家族側からSOSモードをリアルタイムに切替可能
- [ ] デフォルトがサイレントモードに設定されている
