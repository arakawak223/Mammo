# セキュリティ・プライバシー設計

---

## 1. 設計思想

### 基本原則

本アプリは**通話内容・位置情報・個人の行動データ**という極めてセンシティブな情報を扱う。
以下の原則に基づき、ユーザーの信頼を最優先に設計する。

| 原則 | 内容 |
|------|------|
| **最小権限** | 機能に必要な最小限のデータのみ収集・保持 |
| **データ最小化** | 音声は録音しない（テキスト変換後に破棄）。位置情報はSOS時のみ継続取得 |
| **透明性** | 何のデータをなぜ収集しているかを平易な日本語で説明 |
| **ユーザー制御** | すべてのデータは削除可能。機能単位での無効化が可能 |
| **End-to-End思考** | データの生成から破棄までのライフサイクル全体を管理 |

---

## 2. データ分類と取り扱い

### 2.1 データ分類

| 分類 | データ例 | 機密レベル | 保存期間 |
|------|----------|-----------|----------|
| 個人識別情報 | 氏名、電話番号、メールアドレス | 高 | アカウント削除まで |
| 位置情報 | GPS座標（SOS時） | 高 | SOS解除後30日 |
| 通話メタデータ | 発着信番号、通話時間、日時 | 中 | 90日（設定変更可） |
| SMS内容 | SMS本文（詐欺判定後） | 高 | 判定完了後即時削除（スコアのみ保持） |
| 音声テキスト | F3の音声認識結果 | 高 | AI解析完了後7日で削除 |
| AI解析結果 | サマリー、スコア | 中 | 90日 |
| ブロックリスト | 拒否設定番号リスト | 低 | アカウント削除まで |
| 統計データ | 警察庁データ（公開情報） | 低 | 無期限 |
| SOS音声 | 周囲録音データ | 最高 | SOS解除後7日で自動削除 |
| デバイス情報 | OS、機種、アプリバージョン | 低 | 最新のみ保持 |

### 2.2 データフロー

```
[高齢者端末]                [サーバー]                [家族端末]
     │                          │                         │
     │  着信番号(暗号化)   │                         │
     │ ────────────────→  │                         │
     │                     │  復号→判定→暗号化保存   │
     │                     │                         │
     │                     │  通知(番号マスク可)  │
     │                     │ ──────────────────→  │
     │                          │                         │
     │  ※SMS本文は           │                         │
     │   iOS: デバイス内判定   │                         │
     │   Android: 暗号化送信→ │                         │
     │            判定後即破棄 │                         │
```

---

## 3. 認証・認可

### 3.1 認証方式

| 項目 | 実装 |
|------|------|
| 初回登録 | 電話番号 + SMS OTP 認証 |
| ログイン | JWT (Access Token: 15分 / Refresh Token: 30日) |
| トークン保存 | iOS Keychain / Android EncryptedSharedPreferences |
| セッション管理 | Refresh Token Rotation（使用済みトークンの再利用検知） |

### 3.2 認可モデル

```
Role-Based Access Control (RBAC)
│
├─ elderly（高齢者）
│   ├─ イベント送信（F1, F9）
│   ├─ 自端末のデータ閲覧
│   └─ ペアリング承認/解除
│
├─ family_owner（家族オーナー）
│   ├─ elderly のすべてのデータ閲覧
│   ├─ ブロックリスト編集
│   ├─ SOS解除
│   ├─ メンバーの招待/削除
│   └─ 設定変更
│
└─ family_member（家族メンバー）
    ├─ elderly のデータ閲覧
    ├─ ブロックリスト編集
    └─ SOS解除
```

### 3.3 ペアリングのセキュリティ

| 要件 | 実装 |
|------|------|
| 招待コード | 6桁英数字、有効期限30分、1回限り有効 |
| QRコード | 招待コードのQRエンコード版 |
| ペアリング承認 | 高齢者端末での確認画面表示（初期セットアップ時は家族が操作） |
| ペアリング解除 | 双方から可能。解除時は相手に通知 |

---

## 4. 暗号化

### 4.1 通信の暗号化

| 項目 | 方式 |
|------|------|
| API通信 | TLS 1.3（HTTPS必須） |
| WebSocket | WSS (TLS 1.3) |
| Certificate Pinning | 実施（主要ドメインに対して） |

### 4.2 保存データの暗号化

| 項目 | 方式 |
|------|------|
| DB | Amazon RDS 暗号化（AES-256、AWS KMS管理） |
| S3 | SSE-S3 (AES-256) |
| 端末ローカル | iOS Keychain / Android EncryptedSharedPreferences |
| 機密フィールド | アプリケーションレベル暗号化（電話番号等はハッシュ + 暗号化保存） |

### 4.3 SOS音声データの特別扱い

SOS音声はもっとも機密性の高いデータとして以下の追加措置を適用する。

| 項目 | 実装 |
|------|------|
| 転送 | E2E暗号化（サーバーでも復号不可。家族端末でのみ復号） |
| 保存 | 専用の暗号化バケット、アクセスログ全記録 |
| 削除 | SOS解除後7日で自動削除。物理削除（論理削除不可） |
| アクセス | family_owner / family_member のみ。管理者でもアクセス不可 |

---

## 5. 通話内容の取り扱い（重要）

通話内容は本アプリが扱うデータの中で最もセンシティブである。以下の方針を厳守する。

### 5.1 原則: 通話音声は録音しない

| 状況 | 取り扱い |
|------|----------|
| 通常の通話 | **録音しない**。通話メタデータ（番号、時間）のみ取得 |
| F3 音声アシスタント | 通話終了**後**の対話を音声認識。通話そのものは録音しない |
| F5 会話サマリー | F3で得たテキスト、または家族が手動入力したテキストを解析。通話音声は使用しない |
| F9 緊急SOS | 周囲音声のみ録音（通話音声ではない）。E2E暗号化で家族にのみ共有 |

### 5.2 Android 通話録音の選択肢（将来検討）

Android で通話録音を実装する場合（将来のオプション機能として）:

| 要件 | 内容 |
|------|------|
| 同意 | 高齢者と相手方双方の同意が望ましい（日本法では一方当事者同意で合法だが、倫理的配慮） |
| 通知 | 通話開始時にビープ音で録音を通知 |
| 保存 | E2E暗号化、サーバーに送信後に端末から即削除 |
| 保持期間 | AI解析完了後7日で自動削除 |
| アクセス | ペアリングされた家族のみ |

**MVP（Phase 1〜2）では通話録音機能は実装しない。** F3のテキストベース解析で代替する。

---

## 6. プライバシーポリシーの要点

### 6.1 ユーザーへの説明事項

以下を平易な日本語で説明するプライバシーポリシーおよびアプリ内説明を作成する。

1. **収集するデータ**: 着信番号、SMS送信元、位置情報（SOS時のみ）、音声認識テキスト
2. **収集しないデータ**: 通話音声の録音、SMS全文のサーバー保存（iOS）、連絡先データのサーバー送信
3. **データの利用目的**: 詐欺検知と家族への通知のみ。広告・マーケティングには一切使用しない
4. **データの共有先**: ペアリングされた家族のみ。第三者提供なし（法令に基づく場合を除く）
5. **データの保存期間**: 分類ごとの保存期間（上表参照）
6. **ユーザーの権利**: データの閲覧、削除、エクスポート、機能の無効化

### 6.2 同意取得フロー

```
初期セットアップ時（家族が高齢者端末を操作）
  │
  ├─ 画面1: アプリの説明（「このアプリは何をするか」を大きな文字で）
  │
  ├─ 画面2: データの取り扱い説明（何を収集し、何を収集しないか）
  │
  ├─ 画面3: 権限の説明（なぜ各権限が必要か）
  │    ├─ 「電話の権限 → 不審な着信を検知するため」
  │    ├─ 「SMSの権限 → 詐欺SMSを検知するため」
  │    ├─ 「位置情報 → 緊急時に家族に現在地を知らせるため」
  │    └─ 「マイク → 緊急時に周囲の音を家族に送るため」
  │
  ├─ 画面4: 同意確認（チェックボックス＋署名）
  │    ├─ □ プライバシーポリシーを読み、同意します
  │    └─ □ 家族（管理者名）とのペアリングに同意します
  │
  └─ ※家族が代理で同意操作を行うが、高齢者本人の意思確認が前提
```

---

## 7. インフラセキュリティ

| 項目 | 実装 |
|------|------|
| ネットワーク | VPC内にバックエンド配置、パブリックアクセスはAPI Gateway経由のみ |
| DB アクセス | VPC内からのみ。パブリックアクセス無効 |
| シークレット管理 | AWS Secrets Manager（API キー、DB認証情報） |
| WAF | AWS WAF（SQLi、XSS、レート制限） |
| DDoS | AWS Shield Standard |
| ログ | CloudTrail（API操作ログ）、CloudWatch Logs（アプリログ） |
| 脆弱性スキャン | ECR イメージスキャン、定期的な依存関係監査（npm audit, safety check） |
| インシデント対応 | CloudWatch Alarm → SNS → PagerDuty（障害時の自動通知） |

---

## 8. 法令遵守

| 法令 | 対応 |
|------|------|
| 個人情報保護法 | 利用目的の明示、同意取得、安全管理措置、開示請求対応 |
| 電気通信事業法 | 通信の秘密の保護。通信内容は録音しない設計 |
| 特定電子メール法 | アプリからのプッシュ通知は対象外だが、メール通知する場合は準拠 |
| Apple App Store ガイドライン | CallDirectory Extension ガイドライン準拠、バックグラウンド実行の正当な理由 |
| Google Play ポリシー | SMS/Call Log権限の使用はコア機能に限定。Googleへの事前申請が必要 |
| GDPR（将来の海外展開時） | 現時点では対象外だが、設計段階からデータポータビリティ・削除権を考慮 |

### Google Play の SMS/Call Log 権限に関する注意

Google Play では SMS および Call Log 権限の使用に厳しい制限がある。

- **デフォルトハンドラーアプリ**であるか、**Google Play への事前承認**が必要
- 申請時にアプリの目的と必要性を詳細に説明する必要がある
- 防犯アプリとしての正当性を主張し、事前に Google Play チームと協議することを推奨

---

## 8.5 警察との連携における情報管理

### 8.5.1 基本方針

本アプリは将来的に警察庁推奨を目指すが、**ユーザーデータを警察に自動提供することはしない**。データ提供は以下の場合に限定する。

| 状況 | 対応 |
|------|------|
| ユーザー（家族）が自発的に警察に相談 | アプリ内から「警察に共有」ボタンでレポート生成。共有範囲はユーザーが選択 |
| 裁判所の令状に基づく開示請求 | 法令に基づき必要最小限のデータを開示。ユーザーに通知（法令で禁止されない限り） |
| 統計データの提供 | 個人を特定できない匿名化された統計データのみ（詐欺手口の傾向等） |

### 8.5.2 「警察に共有」レポート機能（Phase 2以降）

家族が警察に相談する際、アプリ内の情報を整理したレポートを生成する。

```
共有レポートに含まれるデータ（ユーザーが選択）：
  ├─ 不審な着信の番号と日時
  ├─ AI解析結果のサマリーとスコア
  ├─ SMS本文（ユーザーが選択した場合のみ）
  └─ SOS時の位置情報履歴（ユーザーが選択した場合のみ）

共有レポートに含まれないデータ：
  ├─ SOS音声録音（プライバシー最優先）
  ├─ 高齢者の連絡先リスト
  └─ 家族の個人情報
```

### 8.5.3 警察フィードバックのセキュリティ

開発中の警察へのデモ・フィードバック収集において、実ユーザーのデータは使用しない。デモ用のダミーデータセットを準備する。

---

## 9. 不正利用の防止

本アプリは「家族が高齢者を管理する」という構造上、悪用リスクがある（DV、ストーキング等）。

### 9.1 対策

| リスク | 対策 |
|--------|------|
| ペアリングの悪用（本人の同意なく監視） | ペアリング時の本人同意画面、定期的な「見守られています」通知 |
| 位置追跡の悪用 | SOS時のみ位置追跡（常時追跡はしない）。SOS解除で追跡停止 |
| ブロックリストの悪用（正当な連絡先をブロック） | ブロック時に高齢者端末にも通知。操作ログの保持 |
| 音声盗聴 | SOS時のみ録音。アラームモードでは明確な表示、サイレントモードでも極小アイコンで作動中を表示 |
| SOSサイレントモードの悪用 | サイレントモードは犯罪者に気づかれない設計だが、盗聴にも使える。→ SOS発動は全て家族に通知。高齢者端末にも極小アイコン表示。SOS履歴は全て記録 |

### 9.2 高齢者側のセーフガード

| 機能 | 内容 |
|------|------|
| 見守り通知 | 月1回「○○さんがあなたを見守っています」と通知 |
| ペアリング確認 | 設定画面で現在のペアリング相手を確認・解除可能（大きなボタン） |
| 相談窓口 | アプリ内に「困ったときは」→ 地域包括支援センター、警察相談 #9110 の案内 |

---

## 10. 監査とコンプライアンス

| 項目 | 頻度 | 内容 |
|------|------|------|
| セキュリティ監査 | 年1回 | 外部セキュリティ会社による脆弱性診断 |
| ペネトレーションテスト | 年1回 | API、モバイルアプリの侵入テスト |
| 依存関係監査 | 月1回 | npm audit、safety check の定期実行 |
| アクセスログ監査 | 四半期 | 管理者のデータアクセスログの確認 |
| プライバシー影響評価 | 新機能追加時 | 新機能が扱うデータのリスク評価 |
